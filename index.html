<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flat Earth Model v6 - –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            background: #000;
        }
        .container { display: flex; height: 100vh; }
        #canvas { flex: 1; display: block; }
        .panel {
            width: 380px;
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            padding: 15px;
            overflow-y: auto;
            box-shadow: -5px 0 15px rgba(0,0,0,0.3);
        }
        .panel h1 {
            font-size: 20px;
            margin-bottom: 15px;
            color: #4ecdc4;
            text-align: center;
        }
        .section {
            margin-bottom: 15px;
            background: rgba(255,255,255,0.05);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(78, 205, 196, 0.2);
        }
        .section-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #4ecdc4;
        }
        .control-group { margin-bottom: 10px; }
        .control-group label {
            display: block;
            margin-bottom: 4px;
            font-size: 12px;
            color: #b0b0b0;
        }
        .control-group input, .control-group select {
            width: 100%;
            padding: 6px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(78, 205, 196, 0.3);
            border-radius: 4px;
            color: #e0e0e0;
            font-size: 13px;
        }
        .time-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .btn {
            width: 100%;
            padding: 8px;
            background: linear-gradient(135deg, #4ecdc4 0%, #3aa99f 100%);
            border: none;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            font-size: 13px;
            margin-top: 8px;
        }
        .btn:hover { box-shadow: 0 3px 10px rgba(78, 205, 196, 0.4); }
        .btn-secondary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }
        .speed-control { display: flex; align-items: center; gap: 8px; margin-top: 8px; }
        .speed-control input[type="range"] { flex: 1; }
        .speed-label { min-width: 50px; text-align: center; font-weight: bold; color: #4ecdc4; font-size: 12px; }
        #currentTime {
            text-align: center;
            padding: 8px;
            background: rgba(78, 205, 196, 0.1);
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 16px;
            font-weight: bold;
            color: #4ecdc4;
        }
        #celestialInfo {
            font-size: 11px;
            color: #888;
            margin-top: 8px;
            padding: 8px;
            background: rgba(0,0,0,0.2);
            border-radius: 4px;
            line-height: 1.4;
        }
        #eventList { max-height: 200px; overflow-y: auto; }
        #eventList > div {
            background: rgba(0,0,0,0.2);
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 8px;
            font-size: 12px;
        }
        #eventList button {
            margin-top: 6px;
            padding: 4px 8px;
            background: #ff6b6b;
            border: none;
            border-radius: 3px;
            color: white;
            cursor: pointer;
            font-size: 11px;
        }
        hr { border: none; height: 1px; background: rgba(78, 205, 196, 0.2); margin: 8px 0; }
    </style>
</head>
<body>
    <div class="container">
        <canvas id="canvas"></canvas>
        <div class="panel">
            <h1>üåç Flat Earth Model v6</h1>
            
            <div class="section">
                <div class="section-title">‚è∞ –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è</div>
                <div id="currentTime">--:--:--</div>
                <div id="celestialInfo">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
                
                <div class="btn-group">
                    <button class="btn" id="playBtn" onclick="togglePlay()">‚ñ∂ –ü—É—Å–∫</button>
                    <button class="btn btn-secondary" onclick="resetTime()">üîÑ –°–±—Ä–æ—Å</button>
                </div>
                
                <div class="speed-control">
                    <label style="min-width: 70px; color: #b0b0b0; font-size: 12px;">–°–∫–æ—Ä–æ—Å—Ç—å:</label>
                    <input type="range" id="speedSlider" min="1" max="10000" value="60" step="1">
                    <span class="speed-label" id="speedLabel">60x</span>
                </div>
            </div>
            
            <div class="section">
                <div class="section-title">üìÖ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Ä–µ–º—è</div>
                <div class="control-group">
                    <label>–ì–æ–¥</label>
                    <input type="number" id="year" value="2025" min="1900" max="2100">
                </div>
                <div class="time-controls">
                    <div class="control-group">
                        <label>–ú–µ—Å—è—Ü</label>
                        <input type="number" id="month" value="11" min="1" max="12">
                    </div>
                    <div class="control-group">
                        <label>–î–µ–Ω—å</label>
                        <input type="number" id="day" value="25" min="1" max="31">
                    </div>
                </div>
                <div class="time-controls">
                    <div class="control-group">
                        <label>–ß–∞—Å</label>
                        <input type="number" id="hour" value="12" min="0" max="23">
                    </div>
                    <div class="control-group">
                        <label>–ú–∏–Ω—É—Ç—ã</label>
                        <input type="number" id="minute" value="0" min="0" max="59">
                    </div>
                </div>
                <button class="btn" onclick="updateTimeFromInputs()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            </div>

            <div class="section">
                <div class="section-title">üåë –°–æ–±—ã—Ç–∏—è –∑–∞—Ç–º–µ–Ω–∏–π</div>
                <div id="eventList">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script type="module">
        import SurfaceLayer from './layers/layer0-surface.js';

        let scene, camera, renderer, controls, surfaceLayer;
        let sunMesh, moonMesh, sunLight, moonLight;
        let sunSpotMesh, moonSpotMesh;
        let earthPlane;
        
        let timeState = { year: 2025, month: 11, day: 25, hour: 12, minute: 0, second: 0 };
        let isPlaying = false;
        let timeSpeed = 60;
        let lastFrameTime = Date.now();

        const EARTH_RADIUS = 20000;
        const SUN_HEIGHT = 5000;
        const MOON_HEIGHT = 4000;
        const SUN_ORBIT_RADIUS_MIN = EARTH_RADIUS * 0.25;
        const SUN_ORBIT_RADIUS_MAX = EARTH_RADIUS * 0.45;
        const MOON_ORBIT_RADIUS = EARTH_RADIUS * 0.35;

        // ========== –†–ï–ê–õ–ò–°–¢–ò–ß–ù–´–ï –î–ê–ù–ù–´–ï –û–ë –û–°–í–ï–©–ï–ù–ò–ò ==========
        
        function getMoonIntensity(phase) {
            const I_max = 0.25;
            const intensity = I_max * Math.pow(Math.sin(Math.PI * phase), 2);
            return intensity;
        }

        // ========== –ê–°–¢–†–û–ù–û–ú–ò–ß–ï–°–ö–ò–ï –†–ê–°–ß–Å–¢–´ ==========
        
        function getDayOfYear(year, month, day) {
            const date = new Date(year, month - 1, day);
            const start = new Date(year, 0, 1);
            return Math.floor((date - start) / 86400000) + 1;
        }

        function isLeapYear(year) {
            return (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);
        }

        function getSolarDeclination(dayOfYear, year) {
            const daysInYear = isLeapYear(year) ? 366 : 365;
            const maxDeclination = 23.44 * Math.PI / 180;
            const summerSolstice = 172;
            const angle = 2 * Math.PI * (dayOfYear - summerSolstice) / daysInYear;
            return maxDeclination * Math.cos(angle);
        }

        function getSunOrbitRadius(declination) {
            const normalizedDeclination = declination / (23.44 * Math.PI / 180);
            const midRadius = (SUN_ORBIT_RADIUS_MIN + SUN_ORBIT_RADIUS_MAX) / 2;
            const radiusRange = (SUN_ORBIT_RADIUS_MAX - SUN_ORBIT_RADIUS_MIN) / 2;
            return midRadius - normalizedDeclination * radiusRange;
        }

        function getMoonPhase(year, month, day) {
            const synodicMonth = 29.53;
            const knownNewMoon = new Date(2000, 0, 6);
            const currentDate = new Date(year, month - 1, day);
            const daysSinceNewMoon = (currentDate - knownNewMoon) / 86400000;
            const phase = (daysSinceNewMoon % synodicMonth) / synodicMonth;
            return phase < 0 ? phase + 1 : phase;
        }

        function calculateCelestialPositions(time) {
            const dayOfYear = getDayOfYear(time.year, time.month, time.day);
            const declination = getSolarDeclination(dayOfYear, time.year);
            const sunOrbitRadius = getSunOrbitRadius(declination);
            
            const hourFraction = (time.hour + time.minute / 60 + time.second / 3600) / 24;
            const hourAngle = -hourFraction * 2 * Math.PI;
            
            const sunX = sunOrbitRadius * Math.cos(hourAngle);
            const sunZ = sunOrbitRadius * Math.sin(hourAngle);
            const sunY = SUN_HEIGHT;
            
            // –õ–£–ù–ê: –ø–æ–ª—É—á–∞–µ—Ç —Ñ–∞–∑–Ω—ã–π —Å–¥–≤–∏–≥ –æ—Ç –Ω–æ–≤–æ–ª—É–Ω–∏—è
            const moonPhase = getMoonPhase(time.year, time.month, time.day);
            const moonPhaseAngle = moonPhase * 2 * Math.PI;
            const moonAngle = hourAngle + moonPhaseAngle;
            const moonX = MOON_ORBIT_RADIUS * Math.cos(moonAngle);
            const moonZ = MOON_ORBIT_RADIUS * Math.sin(moonAngle);
            const moonY = MOON_HEIGHT;
            
            const season = getSeason(dayOfYear);
            
            return {
                sun: { x: sunX, y: sunY, z: sunZ, orbitRadius: sunOrbitRadius, declination: declination * 180 / Math.PI },
                moon: { 
                    x: moonX, 
                    y: moonY, 
                    z: moonZ, 
                    phase: moonPhase, 
                    phaseName: getMoonPhaseName(moonPhase),
                    intensity: getMoonIntensity(moonPhase)
                },
                dayOfYear: dayOfYear,
                season: season,
                hourAngle: hourAngle * 180 / Math.PI
            };
        }

        function getSeason(dayOfYear) {
            if (dayOfYear >= 80 && dayOfYear < 172) return '–í–µ—Å–Ω–∞';
            if (dayOfYear >= 172 && dayOfYear < 266) return '–õ–µ—Ç–æ';
            if (dayOfYear >= 266 && dayOfYear < 355) return '–û—Å–µ–Ω—å';
            return '–ó–∏–º–∞';
        }

        function getMoonPhaseName(phase) {
            if (phase < 0.03 || phase > 0.97) return '–ù–æ–≤–æ–ª—É–Ω–∏–µ';
            if (phase < 0.22) return '–ú–æ–ª–æ–¥–∞—è –ª—É–Ω–∞';
            if (phase < 0.28) return '–ü–µ—Ä–≤–∞—è —á–µ—Ç–≤–µ—Ä—Ç—å';
            if (phase < 0.47) return '–ü—Ä–∏–±—ã–≤–∞—é—â–∞—è';
            if (phase < 0.53) return '–ü–æ–ª–Ω–æ–ª—É–Ω–∏–µ';
            if (phase < 0.72) return '–£–±—ã–≤–∞—é—â–∞—è';
            if (phase < 0.78) return '–ü–æ—Å–ª–µ–¥–Ω—è—è —á–µ—Ç–≤–µ—Ä—Ç—å';
            return '–°—Ç–∞—Ä–∞—è –ª—É–Ω–∞';
        }

        // ========== –ó–ê–ì–†–£–ó–ö–ê –°–û–ë–´–¢–ò–ô ==========
        
        async function loadEvents() {
            try {
                const resp = await fetch('./assets/events/eclipse_events.json');
                const events = await resp.json();
                const eventList = document.getElementById('eventList');
                eventList.innerHTML = events.map(ev => `
                    <div>
                        <b>${ev.event === 'solar_eclipse' ? '‚òÄÔ∏è –°–æ–ª–Ω–µ—á–Ω–æ–µ' : 'üåô –õ—É–Ω–Ω–æ–µ'} –∑–∞—Ç–º–µ–Ω–∏–µ</b><br>
                        üìÖ ${ev.date.slice(0,10)}<br>
                        üìç ${ev.description}<br>
                        <button onclick="window.setEventTime('${ev.date}',${ev.longitude},${ev.latitude})">–ü–æ–∫–∞–∑–∞—Ç—å</button>
                    </div>
                `).join('<hr>');
            } catch (error) {
                document.getElementById('eventList').innerHTML = '‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
            }
        }

        // ========== –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–ê ==========
        
        function updateTimeDisplay() {
            const h = String(timeState.hour).padStart(2, '0');
            const m = String(timeState.minute).padStart(2, '0');
            const s = String(Math.floor(timeState.second)).padStart(2, '0');
            document.getElementById('currentTime').textContent = 
                `${timeState.year}-${String(timeState.month).padStart(2, '0')}-${String(timeState.day).padStart(2, '0')} ${h}:${m}:${s}`;
        }

        function updateCelestialInfo(positions) {
            const info = document.getElementById('celestialInfo');
            const moonLux = positions.moon.intensity;
            const sunAltitude = (positions.sun.y / EARTH_RADIUS * 100).toFixed(1);
            const moonAltitude = (positions.moon.y / EARTH_RADIUS * 100).toFixed(1);
            info.innerHTML = `
                <b>‚òÄÔ∏è –°–æ–ª–Ω—Ü–µ:</b> –æ—Ä–±–∏—Ç–∞ ${Math.round(positions.sun.orbitRadius)}–º, —Å–∫–ª–æ–Ω–µ–Ω–∏–µ ${positions.sun.declination.toFixed(1)}¬∞<br>
                <b>üåô –õ—É–Ω–∞:</b> ${positions.moon.phaseName} (${Math.round(positions.moon.phase * 100)}%)<br>
                <b>üí° –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å:</b> ${moonLux.toFixed(4)} –ª—é–∫—Å<br>
                <b>üåÖ –í—ã—Å–æ—Ç—ã:</b> –°–æ–ª–Ω—Ü–µ ${sunAltitude}%, –õ—É–Ω–∞ ${moonAltitude}%<br>
                <b>üóì –°–µ–∑–æ–Ω:</b> ${positions.season} | –î–µ–Ω—å: ${positions.dayOfYear}
            `;
        }

        // ========== –£–ü–†–ê–í–õ–ï–ù–ò–ï –í–†–ï–ú–ï–ù–ï–ú ==========
        
        window.setEventTime = (date, lon, lat) => {
            const d = new Date(date);
            timeState.year = d.getUTCFullYear();
            timeState.month = d.getUTCMonth() + 1;
            timeState.day = d.getUTCDate();
            timeState.hour = d.getUTCHours();
            timeState.minute = d.getUTCMinutes();
            timeState.second = 0;
            
            document.getElementById('year').value = timeState.year;
            document.getElementById('month').value = timeState.month;
            document.getElementById('day').value = timeState.day;
            document.getElementById('hour').value = timeState.hour;
            document.getElementById('minute').value = timeState.minute;
            
            updateModel();
            updateTimeDisplay();
            if (surfaceLayer) surfaceLayer.showEclipseMarker(lon, lat);
        };

        window.updateTimeFromInputs = () => {
            timeState.year = parseInt(document.getElementById('year').value);
            timeState.month = parseInt(document.getElementById('month').value);
            timeState.day = parseInt(document.getElementById('day').value);
            timeState.hour = parseInt(document.getElementById('hour').value);
            timeState.minute = parseInt(document.getElementById('minute').value);
            timeState.second = 0;
            updateModel();
            updateTimeDisplay();
        };

        window.togglePlay = () => {
            isPlaying = !isPlaying;
            document.getElementById('playBtn').textContent = isPlaying ? '‚è∏ –ü–∞—É–∑–∞' : '‚ñ∂ –ü—É—Å–∫';
        };

        window.resetTime = () => {
            const now = new Date();
            timeState = {
                year: now.getFullYear(),
                month: now.getMonth() + 1,
                day: now.getDate(),
                hour: now.getHours(),
                minute: now.getMinutes(),
                second: now.getSeconds()
            };
            document.getElementById('year').value = timeState.year;
            document.getElementById('month').value = timeState.month;
            document.getElementById('day').value = timeState.day;
            document.getElementById('hour').value = timeState.hour;
            document.getElementById('minute').value = timeState.minute;
            updateModel();
            updateTimeDisplay();
        };

        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø 3D –°–¶–ï–ù–´ ==========
        
        function createEarthPlane() {
            const geometry = new THREE.CircleGeometry(EARTH_RADIUS, 256);
            const canvas = document.createElement('canvas');
            canvas.width = 2048;
            canvas.height = 2048;
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = '#1a1a2a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = '#0d4d3f';
            ctx.beginPath();
            ctx.arc(canvas.width / 2, canvas.height / 2, canvas.width / 3, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = '#0a3a2e';
            for (let i = 0; i < 50; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height;
                const size = Math.random() * 20 + 5;
                ctx.fillRect(x, y, size, size);
            }
            
            const texture = new THREE.CanvasTexture(canvas);
            texture.magFilter = THREE.NearestFilter;
            
            const material = new THREE.MeshBasicMaterial({ 
                map: texture,
                side: THREE.DoubleSide
            });
            earthPlane = new THREE.Mesh(geometry, material);
            earthPlane.rotation.x = -Math.PI / 2;
            earthPlane.position.y = 0;
            scene.add(earthPlane);
        }

        function createSunMesh() {
            const geometry = new THREE.SphereGeometry(400, 32, 32);
            const material = new THREE.MeshBasicMaterial({ color: 0xFFDD44, transparent: true, opacity: 0.95 });
            sunMesh = new THREE.Mesh(geometry, material);
            scene.add(sunMesh);
            
            const glowGeometry = new THREE.SphereGeometry(600, 32, 32);
            const glowMaterial = new THREE.MeshBasicMaterial({ color: 0xFFFF88, transparent: true, opacity: 0.3 });
            const glowMesh = new THREE.Mesh(glowGeometry, glowMaterial);
            sunMesh.add(glowMesh);
            
            sunLight = new THREE.PointLight(0xFFFFCC, 2, 60000);
            sunMesh.add(sunLight);
            
            const spotGeometry = new THREE.CircleGeometry(3500, 128);
            const spotMaterial = new THREE.MeshBasicMaterial({ 
                color: 0xFFFF99, 
                transparent: true, 
                opacity: 0.35,
                side: THREE.DoubleSide 
            });
            sunSpotMesh = new THREE.Mesh(spotGeometry, spotMaterial);
            sunSpotMesh.rotation.x = -Math.PI / 2;
            sunSpotMesh.position.y = 15;
            scene.add(sunSpotMesh);
        }

        function createMoonMesh() {
            const geometry = new THREE.SphereGeometry(250, 32, 32);
            const material = new THREE.MeshStandardMaterial({ color: 0xCCCCCC, roughness: 0.8, metalness: 0.1 });
            moonMesh = new THREE.Mesh(geometry, material);
            scene.add(moonMesh);
            
            const craterGeometry = new THREE.CircleGeometry(60, 32);
            const craterMaterial = new THREE.MeshBasicMaterial({ color: 0x666666, transparent: true, opacity: 0.6, side: THREE.DoubleSide });
            const craterMesh = new THREE.Mesh(craterGeometry, craterMaterial);
            craterMesh.position.z = 251;
            moonMesh.add(craterMesh);
            
            moonLight = new THREE.PointLight(0x8888FF, 0.5, 40000);
            moonMesh.add(moonLight);
            
            const spotGeometry = new THREE.CircleGeometry(3200, 128);
            const spotMaterial = new THREE.MeshBasicMaterial({ 
                color: 0x7799FF, 
                transparent: true, 
                opacity: 0.4,
                side: THREE.DoubleSide 
            });
            moonSpotMesh = new THREE.Mesh(spotGeometry, spotMaterial);
            moonSpotMesh.rotation.x = -Math.PI / 2;
            moonSpotMesh.position.y = 8;
            scene.add(moonSpotMesh);
        }

        function initScene() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000510);
            scene.fog = new THREE.Fog(0x000510, 80000, 250000);
            
            camera = new THREE.PerspectiveCamera(60, (window.innerWidth - 380) / window.innerHeight, 100, 500000);
            camera.position.set(0, 40000, 40000);
            camera.lookAt(0, 0, 0);
            
            const canvas = document.getElementById('canvas');
            renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
            renderer.setSize(window.innerWidth - 380, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.minDistance = 10000;
            controls.maxDistance = 120000;
            
            const ambientLight = new THREE.AmbientLight(0x202040, 0.25);
            scene.add(ambientLight);
            
            createEarthPlane();
            createSunMesh();
            createMoonMesh();
            
            surfaceLayer = new SurfaceLayer(scene, { earthRadius: EARTH_RADIUS });
            
            window.resetTime();
            loadEvents();
            
            document.getElementById('speedSlider').addEventListener('input', (e) => {
                timeSpeed = parseInt(e.target.value);
                document.getElementById('speedLabel').textContent = timeSpeed + 'x';
            });
            
            animate();
        }

        // ========== –û–ë–ù–û–í–õ–ï–ù–ò–ï –ú–û–î–ï–õ–ò ==========
        
        function updateModel() {
            const positions = calculateCelestialPositions(timeState);
            
            if (sunMesh) {
                sunMesh.position.set(positions.sun.x, positions.sun.y, positions.sun.z);
                sunSpotMesh.position.set(positions.sun.x, 15, positions.sun.z);
                const spotScale = 1 + Math.abs(positions.sun.declination) / 23.44 * 0.5;
                sunSpotMesh.scale.set(spotScale, spotScale, 1);
            }
            
            if (moonMesh) {
                moonMesh.position.set(positions.moon.x, positions.moon.y, positions.moon.z);
                moonSpotMesh.position.set(positions.moon.x, 8, positions.moon.z);
                
                const moonIntensity = positions.moon.intensity;
                const normalizedIntensity = moonIntensity / 0.25;
                
                moonSpotMesh.material.opacity = 0.35 * normalizedIntensity;
                moonLight.intensity = 0.5 * normalizedIntensity;
                
                moonMesh.lookAt(0, 0, 0);
            }
            
            if (surfaceLayer) {
                surfaceLayer.updateLighting(positions.sun, positions.moon);
            }
            
            updateCelestialInfo(positions);
        }

        // ========== –ê–ù–ò–ú–ê–¶–ò–Ø ==========
        
        function advanceTime(deltaSeconds) {
            timeState.second += deltaSeconds;
            
            while (timeState.second >= 60) { timeState.second -= 60; timeState.minute++; }
            while (timeState.minute >= 60) { timeState.minute -= 60; timeState.hour++; }
            while (timeState.hour >= 24) {
                timeState.hour -= 24;
                timeState.day++;
                const daysInMonth = new Date(timeState.year, timeState.month, 0).getDate();
                if (timeState.day > daysInMonth) {
                    timeState.day = 1;
                    timeState.month++;
                    if (timeState.month > 12) { timeState.month = 1; timeState.year++; }
                }
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            
            if (isPlaying) {
                const now = Date.now();
                const deltaTime = (now - lastFrameTime) / 1000;
                lastFrameTime = now;
                advanceTime(deltaTime * timeSpeed);
                updateModel();
                updateTimeDisplay();
            } else {
                lastFrameTime = Date.now();
            }
            
            controls.update();
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = (window.innerWidth - 380) / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth - 380, window.innerHeight);
        });

        window.addEventListener('DOMContentLoaded', initScene);
    </script>
</body>
</html>
