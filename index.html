<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Flat Earth Model v6 — реалистичное пятно по азимутальной проекции</title>
  <style>
    html, body { margin: 0; padding: 0; background: #131313; height: 100%; }
    body { font-family: Segoe UI, sans-serif; }
    #canvas { display:block; background:#16191e; margin:0 auto; }
    .panel {
      position: absolute; right: 0; top: 0; width: 380px; height: 100%;
      background: #222b3d; color:#e0e0e0; padding:18px 24px;
      box-shadow: -3px 0 12px #000c;
      font-size: 16px;
    }
    label { font-size: 13px; color: #b5eaea; }
    input, select { font-size: 14px; width:90px; }
    button { font-size:15px; margin:8px 0;}
  </style>
</head>
<body>
  <canvas id="canvas" width="900" height="900"></canvas>
  <div class="panel">
    <div>
      <label>Дата:</label>
      <input id="date" type="date" value="2025-11-26"><br><br>
      <label>Время (часы:мин):</label>
      <input id="hour" type="number" min="0" max="23" value="12" style="width:50px;">
      :
      <input id="min" type="number" min="0" max="59" value="0" style="width:50px;">
      <button onclick="drawAll()">Показать</button>
    </div>
    <hr>
    <button onclick="step(-1)">◀ -1 ч</button>
    <button onclick="step(1)">+1 ч ▶</button>
    <div id="info" style="font-size:13px;margin-top:12px;line-height:1.5"></div>
  </div>
<script>
const R = 400; // радиус плоскости
const sunColor = [255, 180, 40];
const moonColor = [90,150,255];
const skyColor = [20, 30, 46];
const sunHeight = 200;
const moonHeight = 140;

function toRad(x){return x*Math.PI/180;}

function getPositions(year,month,day,hour,min) {
  // Солнце: угол сезона (лето ближе к центру)
  let d = new Date(year,month-1,day);
  let dayOfYear = Math.floor((d - new Date(year,0,0))/86400000);
  let decl = 23.44*Math.cos(2*Math.PI*(dayOfYear-172)/365.25); // сезон
  let R0 = R*0.6-(decl/23.44)*(R*0.175); // орбита солнца
  let angleSun = -((hour+min/60)/24)*2*Math.PI; // восток-west
  let sun = {
    x: 450 + R0*Math.cos(angleSun),
    y: 450 + R0*Math.sin(angleSun),
    h: sunHeight
  };
  // Луна: фазный сдвиг
  let moonPhase = (((d-new Date(2000,0,6))/86400000)%29.53)/29.53;
  let moonAngle = angleSun + moonPhase*2*Math.PI;
  let moon = {
    x: 450 + R*0.43*Math.cos(moonAngle),
    y: 450 + R*0.43*Math.sin(moonAngle),
    h: moonHeight,
    phase: moonPhase
  };
  return {sun,moon,decl,moonPhase};
}

function grad(v,low,high){return Math.min(1,Math.max(0,(v-low)/(high-low)));}

function drawAll() {
  let [year,month,day] = document.getElementById('date').value.split('-').map(Number);
  let hour = +document.getElementById('hour').value;
  let min = +document.getElementById('min').value;
  let {sun,moon,decl,moonPhase} = getPositions(year,month,day,hour,min);
  let ctx = canvas.getContext('2d');
  ctx.fillStyle = `rgb(${skyColor[0]},${skyColor[1]},${skyColor[2]})`;
  ctx.fillRect(0,0,900,900);

  // главная поверхность
  let img = ctx.getImageData(0,0,900,900);
  let data = img.data;

  for(let y=0;y<900;y++) for(let x=0;x<900;x++){
    let dx = x-450, dy = y-450;
    let r = Math.sqrt(dx*dx+dy*dy);
    let color=[0,0,0];
    if(r<=R){
      // Солнце
      let ds = Math.sqrt((x-sun.x)**2 + (y-sun.y)**2);
      let cosA = sun.h/Math.sqrt(ds*ds+sun.h*sun.h);
      let S = Math.max(0,cosA); // солнце освещает
      // плавные сумерки (линии равной освещенности)
      let sunLum = grad(S,0.07,1);

      // Луна (гораздо слабее)
      let dm = Math.sqrt((x-moon.x)**2 + (y-moon.y)**2);
      let moonAngle = moon.h/Math.sqrt(dm*dm+moon.h*moon.h);
      let moonLum = grad(moonAngle,0.1,1) * Math.pow(Math.sin(Math.PI*moon.phase),2);

      // Затемнение ночи — фон
      let dark = 0.15 + 0.15*moonLum;
      for(let i=0;i<3;i++){
        color[i] = 
          skyColor[i]*dark +
          sunColor[i]*sunLum +
          moonColor[i]*moonLum*0.6;
      }
    }
    let i = 4*(y*900+x);
    data[i]=Math.round(color[0]);
    data[i+1]=Math.round(color[1]);
    data[i+2]=Math.round(color[2]);
    data[i+3]=255;
  }
  ctx.putImageData(img,0,0);

  // Контур земли
  ctx.strokeStyle='#448'; ctx.lineWidth=2;
  ctx.beginPath();
  ctx.arc(450,450,R,0,2*Math.PI); ctx.stroke();

  // Центральная ось и Солнце/Луна
  ctx.fillStyle='yellow'; ctx.beginPath(); ctx.arc(sun.x,sun.y,10,0,2*Math.PI); ctx.fill();
  ctx.strokeStyle='#fff'; ctx.beginPath(); ctx.arc(moon.x,moon.y,8,0,2*Math.PI); ctx.stroke();
  ctx.fillStyle='rgba(140,175,255,0.5)';
  ctx.beginPath(); ctx.arc(moon.x,moon.y,8,0,2*Math.PI); ctx.fill();

  // Инфо
  document.getElementById('info').innerHTML =
    'Деклинация солнца: '+decl.toFixed(1)+'°<br>Фаза луны: '+Math.round(moonPhase*100)+'%<br>Смещение оси: '+(sun.x-450).toFixed(0)+','+(sun.y-450).toFixed(0);
}

function step(dh){
  let hour = +document.getElementById('hour').value + dh;
  if(hour<0){hour=23;document.getElementById('day').value--;}
  if(hour>23){hour=0;document.getElementById('day').value++;}
  document.getElementById('hour').value=hour;
  drawAll();
}

drawAll();
</script>
</body>
</html>
