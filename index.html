<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flat Earth Model v6 - –ñ–∏–≤–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            background: #000;
        }
        .container {
            display: flex;
            height: 100vh;
        }
        #canvas {
            flex: 1;
            display: block;
        }
        .panel {
            width: 420px;
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            padding: 20px;
            overflow-y: auto;
            box-shadow: -5px 0 15px rgba(0,0,0,0.3);
        }
        .panel h1 {
            font-size: 24px;
            margin-bottom: 20px;
            color: #4ecdc4;
            text-align: center;
        }
        .section {
            margin-bottom: 25px;
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(78, 205, 196, 0.2);
        }
        .section-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 12px;
            color: #4ecdc4;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .control-group {
            margin-bottom: 15px;
        }
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 13px;
            color: #b0b0b0;
        }
        .control-group input,
        .control-group select {
            width: 100%;
            padding: 8px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(78, 205, 196, 0.3);
            border-radius: 5px;
            color: #e0e0e0;
            font-size: 14px;
        }
        .control-group input:focus,
        .control-group select:focus {
            outline: none;
            border-color: #4ecdc4;
            box-shadow: 0 0 10px rgba(78, 205, 196, 0.3);
        }
        .time-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .btn {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, #4ecdc4 0%, #3aa99f 100%);
            border: none;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
            font-size: 14px;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(78, 205, 196, 0.4);
        }
        .btn:active {
            transform: translateY(0);
        }
        .btn-secondary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        .speed-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        .speed-control input[type="range"] {
            flex: 1;
        }
        .speed-label {
            min-width: 60px;
            text-align: center;
            font-weight: bold;
            color: #4ecdc4;
        }
        #currentTime {
            text-align: center;
            padding: 10px;
            background: rgba(78, 205, 196, 0.1);
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: bold;
            color: #4ecdc4;
        }
        #eventList {
            max-height: 250px;
            overflow-y: auto;
        }
        #eventList > div {
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 13px;
        }
        #eventList button {
            margin-top: 8px;
            padding: 5px 10px;
            background: #ff6b6b;
            border: none;
            border-radius: 3px;
            color: white;
            cursor: pointer;
            font-size: 12px;
        }
        #eventList button:hover {
            background: #ff5252;
        }
        hr {
            border: none;
            height: 1px;
            background: rgba(78, 205, 196, 0.2);
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <canvas id="canvas"></canvas>
        <div class="panel">
            <h1>üåç Flat Earth Model v6</h1>
            
            <div class="section">
                <div class="section-title">‚è∞ –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è</div>
                <div id="currentTime">--:--:--</div>
                
                <div class="btn-group">
                    <button class="btn" id="playBtn" onclick="togglePlay()">‚ñ∂ –ü—É—Å–∫</button>
                    <button class="btn btn-secondary" onclick="resetTime()">üîÑ –°–±—Ä–æ—Å</button>
                </div>
                
                <div class="speed-control">
                    <label style="min-width: 90px; color: #b0b0b0;">–°–∫–æ—Ä–æ—Å—Ç—å:</label>
                    <input type="range" id="speedSlider" min="1" max="10000" value="60" step="1">
                    <span class="speed-label" id="speedLabel">60x</span>
                </div>
            </div>
            
            <div class="section">
                <div class="section-title">üìÖ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Ä–µ–º—è</div>
                <div class="control-group">
                    <label>–ì–æ–¥</label>
                    <input type="number" id="year" value="2025" min="2000" max="2100">
                </div>
                <div class="time-controls">
                    <div class="control-group">
                        <label>–ú–µ—Å—è—Ü</label>
                        <input type="number" id="month" value="11" min="1" max="12">
                    </div>
                    <div class="control-group">
                        <label>–î–µ–Ω—å</label>
                        <input type="number" id="day" value="25" min="1" max="31">
                    </div>
                </div>
                <div class="time-controls">
                    <div class="control-group">
                        <label>–ß–∞—Å</label>
                        <input type="number" id="hour" value="12" min="0" max="23">
                    </div>
                    <div class="control-group">
                        <label>–ú–∏–Ω—É—Ç—ã</label>
                        <input type="number" id="minute" value="0" min="0" max="59">
                    </div>
                </div>
                <button class="btn" onclick="updateTimeFromInputs()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            </div>

            <div class="section">
                <div class="section-title">üåë –°–æ–±—ã—Ç–∏—è –∑–∞—Ç–º–µ–Ω–∏–π</div>
                <div id="eventList">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>
    </div>

    <canvas id="2dCanvas" style="display:none;"></canvas>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script type="module">
        import SurfaceLayer from './layers/layer0-surface.js';

        let scene, camera, renderer, controls, surfaceLayer;
        let timeState = { year: 2025, month: 11, day: 25, hour: 12, minute: 0, second: 0 };
        let isPlaying = false;
        let timeSpeed = 60;
        let lastFrameTime = Date.now();

        // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 1: –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è —Å–≤–µ—Ç–∏–ª
        // hourAngle —Ç–µ–ø–µ—Ä—å —Å –ú–ò–ù–£–°–û–ú –ø–µ—Ä–µ–¥ —Å–∫–æ–±–∫–∞–º–∏ ‚Äî —ç—Ç–æ –¥–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ —Å –≤–æ—Å—Ç–æ–∫–∞ –Ω–∞ –∑–∞–ø–∞–¥
        function calculateCelestialPositions(time) {
            const earthRadius = 20000;
            const dayOfYear = Math.floor((new Date(time.year, time.month - 1, time.day) - new Date(time.year, 0, 1)) / 86400000) + 1;
            
            // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –¥–æ–±–∞–≤–ª–µ–Ω –º–∏–Ω—É—Å –ø–µ—Ä–µ–¥ ((time.hour...
            const hourAngle = -((time.hour + time.minute / 60 + time.second / 3600) / 24) * 2 * Math.PI;
            
            const sunDistance = earthRadius * 0.4;
            const sunX = sunDistance * Math.cos(hourAngle);
            const sunY = sunDistance * Math.sin(hourAngle);
            
            const moonPhaseShift = dayOfYear * 0.0335;
            const moonAngle = hourAngle + moonPhaseShift;
            const moonDistance = earthRadius * 0.3;
            const moonX = moonDistance * Math.cos(moonAngle);
            const moonY = moonDistance * Math.sin(moonAngle);
            
            // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 2: –î–æ–±–∞–≤–ª–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–∏–¥–∏–º–æ–≥–æ –ª—É–Ω–Ω–æ–≥–æ –ø—è—Ç–Ω–∞ (–∫—Ä–∞—Ç–µ—Ä–∞)
            const moonPhase = (dayOfYear % 29.5) / 29.5;
            
            return { 
                sun: { x: sunX, y: sunY, size: 120 },
                moon: { 
                    x: moonX, 
                    y: moonY, 
                    size: 80,
                    phase: moonPhase,           // ‚úÖ –§–∞–∑–∞ –õ—É–Ω—ã
                    craterOffset: Math.cos(moonPhase * Math.PI * 2) * 30  // ‚úÖ –í–∏–¥–∏–º–æ–µ —Å–º–µ—â–µ–Ω–∏–µ –∫—Ä–∞—Ç–µ—Ä–∞
                } 
            };
        }

        // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 2: –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≤–∏–¥–∏–º–æ–≥–æ –ª—É–Ω–Ω–æ–≥–æ –ø—è—Ç–Ω–∞
        function drawCelestialBodies(ctx, positions, width, height) {
            const centerX = width / 2;
            const centerY = height / 2;
            const scale = 50;
            
            // –°–æ–ª–Ω—Ü–µ
            const sunScreenX = centerX + positions.sun.x / scale;
            const sunScreenY = centerY + positions.sun.y / scale;
            
            if (sunScreenX > 0 && sunScreenX < width && sunScreenY > 0 && sunScreenY < height) {
                ctx.fillStyle = 'rgba(255, 220, 0, 0.9)';
                ctx.beginPath();
                ctx.arc(sunScreenX, sunScreenY, positions.sun.size / scale, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // –õ—É–Ω–∞
            const moonScreenX = centerX + positions.moon.x / scale;
            const moonScreenY = centerY + positions.moon.y / scale;
            
            if (moonScreenX > 0 && moonScreenX < width && moonScreenY > 0 && moonScreenY < height) {
                // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 2: –í–∏–¥–∏–º–æ–µ –ª—É–Ω–Ω–æ–µ –ø—è—Ç–Ω–æ (–∫—Ä–∞—Ç–µ—Ä)
                ctx.fillStyle = 'rgba(200, 200, 200, 0.95)';
                ctx.beginPath();
                ctx.arc(moonScreenX, moonScreenY, positions.moon.size / scale, 0, Math.PI * 2);
                ctx.fill();
                
                // –í–∏–¥–∏–º—ã–π –∫—Ä–∞—Ç–µ—Ä
                ctx.fillStyle = 'rgba(100, 100, 100, 0.7)';
                ctx.beginPath();
                ctx.arc(moonScreenX + positions.moon.craterOffset / scale, moonScreenY, 8, 0, Math.PI * 2);
                ctx.fill();
                
                // –§–∞–∑–∞ –õ—É–Ω—ã (—Ç–µ–Ω—å –Ω–∞ –∫—Ä–∞—é)
                ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                ctx.beginPath();
                ctx.arc(moonScreenX + positions.moon.craterOffset * 0.5 / scale, moonScreenY, positions.moon.size / scale, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π
        async function loadEvents() {
            try {
                const resp = await fetch('./assets/events/eclipse_events.json');
                const events = await resp.json();
                const eventList = document.getElementById('eventList');
                eventList.innerHTML = events.map(ev => `
                    <div>
                        <b>${ev.event === 'solar_eclipse' ? '‚òÄÔ∏è –°–æ–ª–Ω–µ—á–Ω–æ–µ –∑–∞—Ç–º–µ–Ω–∏–µ' : 'üåô –õ—É–Ω–Ω–æ–µ –∑–∞—Ç–º–µ–Ω–∏–µ'}</b><br>
                        ${ev.date.slice(0,10)}<br>
                        ${ev.description}<br>
                        <button onclick="window.setEventTime('${ev.date}',${ev.longitude},${ev.latitude})">üìç –ü–æ–∫–∞–∑–∞—Ç—å</button>
                    </div>
                `).join('<hr>');
            } catch (error) {
                document.getElementById('eventList').innerHTML = '‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π';
            }
        }

        function updateTimeDisplay() {
            const h = String(timeState.hour).padStart(2, '0');
            const m = String(timeState.minute).padStart(2, '0');
            const s = String(Math.floor(timeState.second)).padStart(2, '0');
            document.getElementById('currentTime').textContent = 
                `${timeState.year}-${String(timeState.month).padStart(2, '0')}-${String(timeState.day).padStart(2, '0')} ${h}:${m}:${s}`;
        }

        window.setEventTime = (date, lon, lat) => {
            const d = new Date(date);
            timeState.year = d.getUTCFullYear();
            timeState.month = d.getUTCMonth() + 1;
            timeState.day = d.getUTCDate();
            timeState.hour = d.getUTCHours();
            timeState.minute = d.getUTCMinutes();
            timeState.second = 0;
            
            document.getElementById('year').value = timeState.year;
            document.getElementById('month').value = timeState.month;
            document.getElementById('day').value = timeState.day;
            document.getElementById('hour').value = timeState.hour;
            document.getElementById('minute').value = timeState.minute;
            
            updateModel();
            updateTimeDisplay();
            if (surfaceLayer) surfaceLayer.showEclipseMarker(lon, lat);
        };

        window.updateTimeFromInputs = () => {
            timeState.year = parseInt(document.getElementById('year').value);
            timeState.month = parseInt(document.getElementById('month').value);
            timeState.day = parseInt(document.getElementById('day').value);
            timeState.hour = parseInt(document.getElementById('hour').value);
            timeState.minute = parseInt(document.getElementById('minute').value);
            timeState.second = 0;
            updateModel();
            updateTimeDisplay();
        };

        window.togglePlay = () => {
            isPlaying = !isPlaying;
            const btn = document.getElementById('playBtn');
            btn.textContent = isPlaying ? '‚è∏ –ü–∞—É–∑–∞' : '‚ñ∂ –ü—É—Å–∫';
        };

        window.resetTime = () => {
            timeState = { year: 2025, month: 11, day: 25, hour: 12, minute: 0, second: 0 };
            document.getElementById('year').value = 2025;
            document.getElementById('month').value = 11;
            document.getElementById('day').value = 25;
            document.getElementById('hour').value = 12;
            document.getElementById('minute').value = 0;
            updateModel();
            updateTimeDisplay();
        };

        document.addEventListener('DOMContentLoaded', () => {
            const speedSlider = document.getElementById('speedSlider');
            const speedLabel = document.getElementById('speedLabel');
            speedSlider.addEventListener('input', (e) => {
                timeSpeed = parseInt(e.target.value);
                speedLabel.textContent = timeSpeed + 'x';
            });
        });

        // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 3: –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É–∂–µ –≤—Å—Ç—Ä–æ–µ–Ω–∞ –≤—ã—à–µ
        // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 4: –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞—Ç–º–µ–Ω–∏–π –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ eventList
        // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 5: –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ calculateCelestialPositions –∏ drawCelestialBodies

        function initScene() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000510);
            scene.fog = new THREE.Fog(0x000510, 100000, 300000);
            
            camera = new THREE.PerspectiveCamera(60, (window.innerWidth - 420) / window.innerHeight, 1000, 500000);
            camera.position.set(0, 50000, 50000);
            camera.lookAt(0, 0, 0);
            
            const canvas = document.getElementById('canvas');
            renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
            renderer.setSize(window.innerWidth - 420, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.minDistance = 15000;
            controls.maxDistance = 150000;
            
            scene.add(new THREE.AmbientLight(0x404060, 0.2));
            
            surfaceLayer = new SurfaceLayer(scene, { earthRadius: 20000 });
            
            updateModel();
            updateTimeDisplay();
            loadEvents();
            animate();
        }

        function updateModel() {
            if (surfaceLayer) {
                const positions = calculateCelestialPositions(timeState);
                surfaceLayer.updateLighting(positions.sun, positions.moon);
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            
            if (isPlaying) {
                const now = Date.now();
                const deltaTime = (now - lastFrameTime) / 1000;
                lastFrameTime = now;
                
                timeState.second += deltaTime * timeSpeed;
                
                while (timeState.second >= 60) {
                    timeState.second -= 60;
                    timeState.minute++;
                    if (timeState.minute >= 60) {
                        timeState.minute = 0;
                        timeState.hour++;
                        if (timeState.hour >= 24) {
                            timeState.hour = 0;
                            timeState.day++;
                            if (timeState.day > 30) {
                                timeState.day = 1;
                                timeState.month++;
                                if (timeState.month > 12) {
                                    timeState.month = 1;
                                    timeState.year++;
                                }
                            }
                        }
                    }
                }
                
                updateModel();
                updateTimeDisplay();
            } else {
                lastFrameTime = Date.now();
            }
            
            controls.update();
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = (window.innerWidth - 420) / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth - 420, window.innerHeight);
        });

        window.addEventListener('DOMContentLoaded', initScene);
    </script>
</body>
</html>
